<%@ page import="com.example.dto.StoreDTO" %>
<%@ page import="com.example.dto.ReviewDTO" %>
<%@ page import="java.util.List" %>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%
    StoreDTO store = (StoreDTO) request.getAttribute("store");
    String storeLocation = store.getLocation();
    List<ReviewDTO> reviewList = (List<ReviewDTO>) request.getAttribute("reviewList");
%>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DETAIL</title>
    <link rel="stylesheet" href="./css/detail.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
</head>
<body>
<header class="nav">
    <div class="nav-container">
        <a href="<%=request.getContextPath()%>/">
            <div class="nav-logo">
                <i class="bx bxs-cube"></i>
                <div class="nav-logo-text">MainLogo</div>
            </div>
        </a>
        <div class="search-container">
            <form method="get">
                <div class="search-bar">
                    <input id="search" type="text" placeholder="Í≤ÄÏÉâ" />
                </div>
                <button class="search-icon" type="submit">
                    <label for="search">
                        <i class="bx bx-search"></i>
                    </label>
                </button>
            </form>
        </div>
        <ul class="nav-list">
            <c:choose>
                <c:when test="${not empty sessionScope.user}">
                    <li class="nav-item">
                        <a href="<%=request.getContextPath()%>/profile" class="nav-text">${sessionScope.user.username}Îãò ÌôòÏòÅÌï©ÎãàÎã§.</a>
                    </li>
                </c:when>
                <c:otherwise>
                    <li class="nav-item">
                        <a href="<%=request.getContextPath()%>/login" class="nav-text">Î°úÍ∑∏Ïù∏</a>
                    </li>
                    <li class="nav-item">
                        <a href="<%=request.getContextPath()%>/register" class="nav-text">ÌöåÏõêÍ∞ÄÏûÖ</a>
                    </li>
                </c:otherwise>
            </c:choose>
        </ul>
    </div>
</header>
<main class="main-screen">
    <div class="slider-container">
        <button class="slider-button left" onclick="slideToPrevImage()">&#10094;</button>
        <div class="slider">
            <div class="slider-track">
                <img src="imgServlet?store_id=${requestScope.store.store_id}" />
                <img src="imgServlet?store_id=${requestScope.store.store_id}" />
                <img src="imgServlet?store_id=${requestScope.store.store_id}" />
                <img src="imgServlet?store_id=${requestScope.store.store_id}" />
            </div>
        </div>
        <button class="slider-button right" onclick="slideToNextImage()">&#10095;</button>
    </div>
    <div class="content-container">
        <div class="store-title-container">
            <div class="store-title-rating">
                <div>${requestScope.store.store_name}</div>
                <div class="store-rating">${requestScope.store.rating}</div>
            </div>
            <div class="store-category-container">
                <div class="store-category">#Ïπ¥ÌÖåÍ≥†Î¶¨</div>
                <div class="store-category">#Ïπ¥ÌÖåÍ≥†Î¶¨</div>
            </div>
            <div class="review-count">
                <a href="#" id="review-link"><i class="bx bxs-star"></i>Î¶¨Î∑∞(<%= reviewList != null ? reviewList.size() : 0 %>)</a>
            </div>
        </div>
        <div id="map" style="width: 100%; height: 400px"></div>
        <div class="store-description-container">
            <h1>Îß§Ïû• ÏÜåÍ∞ú</h1>
            <p>
                ${requestScope.store.description}
            </p>
        </div>
        <div class="review-list-container" id="review">
            <div class="review-title">
                <h1>Î¶¨Î∑∞(<%= reviewList != null ? reviewList.size() : 0 %>)</h1>
                <a href="#" id="move-to-review-write">Î¶¨Î∑∞ ÏûëÏÑ±ÌïòÍ∏∞</a>
            </div>
<%--            <div class="review-list">--%>
<%--                <div class="review-item-container">--%>
<%--                    <div class="review-item-title">--%>
<%--                        <div class="nickname">pknu1234</div>--%>
<%--                        <div class="rating">--%>
<%--                            <i id="rate1" class="bx bxs-star"></i>--%>
<%--                            <i id="rate2" class="bx bxs-star"></i>--%>
<%--                            <i id="rate3" class="bx bxs-star"></i>--%>
<%--                            <i id="rate4" class="bx bxs-star"></i>--%>
<%--                            <i id="rate5" class="bx bxs-star"></i>--%>
<%--                        </div>--%>
<%--                    </div>--%>
<%--                    <div class="review-item-content">--%>
<%--                        ÌïòÏù¥Î≥ºÎèÑ ÎßõÏûàÏóàÍµ¨Ïöî!!ÏóêÍ∑∏Ïù∏Ìó¨ÎèÑ ÎßõÏûàÏóàÏñ¥Ïöî!! Îß§Ïû•ÎèÑ ÍπîÎÅî Íπ®ÎÅóÌñàÍ≥† ÌôîÏû•Ïã§ÎèÑ Íπ®ÎÅóÌï¥ÏÑú Ï¢ãÏïòÏñ¥Ïöî!!--%>
<%--                        ÏßÅÏõêÎ∂ÑÎì§ÎèÑ ÏóÑÏ≤≠ ÏπúÏ†àÌïòÏÖ®Ïñ¥Ïöîüòä Î∞•ÏùÑ Î®πÍ≥† 2Ï∞®Î°ú Í∞ÄÏÑú Í∞ÑÎã®Ìûà Î®πÏóàÎäîÎç∞ ÎÑò Ï¢ãÎçîÎùºÍµ¨Ïöî~! Îã§ÏùåÏóê Îã§Î•∏ Î©îÎâ¥--%>
<%--                        ÎßõÎ≥¥Îü¨ Îã§Ïãú Î∞©Î¨∏Ìï¥ÏïºÍ≤†Ïñ¥Ïöî!--%>
<%--                    </div>--%>
<%--                </div>--%>
<%--            </div>--%>
            <c:choose>
                <c:when test="${not empty requestScope.reviewList}">
                    <c:forEach var="review" items="${requestScope.reviewList}">
                        <div class="review-list">
                            <div class="review-item-container">
                                <div class="review-item-title">
                                    <div class="nickname">${review.person_name}</div>
                                    <div class="rating">
                                        <i id="rate12" class="bx bxs-star"></i>
                                        <i id="rate22" class="bx bxs-star"></i>
                                        <i id="rate32" class="bx bxs-star"></i>
                                        <i id="rate42" class="bx bxs-star"></i>
                                        <i id="rate52" class="bx bxs-star"></i>
                                    </div>
                                </div>
                                <div class="review-item-content">
                                    ${review.content}
                                </div>
                            </div>
                        </div>
                    </c:forEach>
                </c:when>
                <c:otherwise>
                    <div class="review-list">
                        <div class="review-item-container">
                            <div class="review-item-content">
                                    Îì±Î°ùÎêú Î¶¨Î∑∞Í∞Ä Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§.
                            </div>
                        </div>
                    </div>
                </c:otherwise>
            </c:choose>
        </div>
        <div class="review-write-container">
            <div class="review-title">
                <h1>Î¶¨Î∑∞ ÏûëÏÑ±ÌïòÍ∏∞</h1>
            </div>
            <div>
                <form name="rating-form" id="rating-form" onsubmit="return validationBeforeSubmit()" method="post">
                    <div class="rating-field">
                        <div class="star-rating">
                            <span data-value="1">‚òÖ</span>
                            <span data-value="2">‚òÖ</span>
                            <span data-value="3">‚òÖ</span>
                            <span data-value="4">‚òÖ</span>
                            <span data-value="5">‚òÖ</span>
                        </div>
                        <span class="text-bold">Î≥ÑÏ†êÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.</span>
                        <input type="hidden" name="reviewStar" id="reviewStar" value="0" />
                    </div>
                    <div>
                        <textarea
                                class="form-control"
                                type="text"
                                id="reviewContents"
                                name="reviewContents"
                                placeholder="Ï¢ãÏùÄ Î¶¨Î∑∞Î•º ÎÇ®Í≤®Ï£ºÏãúÎ©¥ Í∞ÄÍ≤åÏóê ÌÅ∞ ÌûòÏù¥ Îê©ÎãàÎã§."
                                onfocus="validationCheck()"></textarea>
                    </div>
                    <input type="submit" value="Î¶¨Î∑∞ Îì±Î°ùÌïòÍ∏∞" onclick="validationCheck()"/>
                </form>
            </div>
        </div>
    </div>
</main>
<footer class="footer">
    <div class="footer-container">
        <ul class="footer-list">
            <li class="footer-list-item">
                <a href="#">Ïù∏ÌÑ∞ÎÑ∑DBÏùëÏö© 4ÌåÄ</a>
            </li>
            <li class="footer-list-item">
                <a href="#">Í≥µÏû¨ÏÑ±</a>
            </li>
            <li class="footer-list-item">
                <a href="#">ÏûÑÏÑ±Í∑†</a>
            </li>
            <li class="footer-list-item">
                <a href="#">ÏµúÏßÄÏù∏</a>
            </li>
        </ul>
    </div>
    <div class="footer-logo">
        <div class="footer-logo-icon">
            <i class="bx bxl-microsoft"></i>
        </div>
        <div class="footer-logo-text">
            <div>InternetDB</div>
        </div>
    </div>
</footer>
<script
        type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=f8f6f6817f7cfcd384bc8e7e9378fb1a"></script>
<script>
    const sliderTrack = document.querySelector(".slider-track");
    const images = document.querySelectorAll(".slider img");
    const imageCount = images.length;
    let imageWidth = 300;
    let currentIndex = 0;

    function slideToNextImage() {
        currentIndex++;
        if (currentIndex >= imageCount) {
            currentIndex = 0;
        }
        updateSliderPosition();
    }

    function slideToPrevImage() {
        currentIndex--;
        if (currentIndex < 0) {
            currentIndex = imageCount - 1;
        }
        updateSliderPosition();
    }

    function updateSliderPosition() {
        const offset = -currentIndex * imageWidth;
        sliderTrack.style.transform = 'translateX(' + offset+'px)';
    }

    window.addEventListener("resize", () => {
        imageWidth = images[0].clientWidth;
        updateSliderPosition();
    });
    document.querySelector("#review-link").addEventListener("click", function (event) {
        event.preventDefault();
        document.querySelector("#review").scrollIntoView({ behavior: "smooth", block: "center" });
    });
    document.querySelector("#move-to-review-write").addEventListener("click", function (event) {
        event.preventDefault();
        document.querySelector(".review-write-container").scrollIntoView({ behavior: "smooth", block: "center" });
    });
    // kakao map Ï∂îÍ∞Ä
    // ÏßÄÎèÑÎ•º Ï¥àÍ∏∞ÌôîÌïòÎäî Ìï®Ïàò
    let mapContainer = document.getElementById("map"), // ÏßÄÎèÑÎ•º ÌëúÏãúÌï† div
        mapOption = {
            center: new kakao.maps.LatLng(35.1368993, 129.102391), // ÏßÄÎèÑÏùò Ï§ëÏã¨Ï¢åÌëú
            level: 3, // ÏßÄÎèÑÏùò ÌôïÎåÄ Î†àÎ≤®
        };

    // ÏßÄÎèÑÎ•º ÏÉùÏÑ±
    let map = new kakao.maps.Map(mapContainer, mapOption);
    let storeLocation = "<%=storeLocation%>"
    let coords = storeLocation.split(',');
    let lat = parseFloat(coords[0]);
    let lng = parseFloat(coords[1]);
    // ÎßàÏª§Î•º ÏÉùÏÑ±
    let markerPosition = new kakao.maps.LatLng(lat, lng);
    let marker = new kakao.maps.Marker({
        position: markerPosition,
    });

    // ÎßàÏª§Î•º ÏßÄÎèÑÏóê ÌëúÏãú
    marker.setMap(map);

    // Î≥ÑÏ†ê
    const stars = document.querySelectorAll(".star-rating span");
    const reviewStarInput = document.querySelector("#reviewStar");
    stars.forEach((star) => {
        star.addEventListener("click", function () {
            const value = this.getAttribute("data-value");
            resetStars();
            highlightStars(value);
            reviewStarInput.value = value;
            console.log(value);
        });
        star.addEventListener("mouseover", function () {
            const value = this.getAttribute("data-value");
            resetStars();
            highlightStars(value);
        });

        star.addEventListener("mouseout", function () {
            const selectedValue = reviewStarInput.value;
            resetStars();
            highlightStars(selectedValue);
        });
    });

    function resetStars() {
        stars.forEach((star) => {
            star.classList.remove("selected");
            star.style.color = "lightgray";
        });
    }

    function highlightStars(value) {
        stars.forEach((star) => {
            if (star.getAttribute("data-value") <= value) {
                star.classList.add("selected");
                star.style.color = "gold";
            }
        });
    }

    const form = document.querySelector('#rating-form');
    form.addEventListener("submit", function(event){
        const confirmed = confirm('Î¶¨Î∑∞Î•º Îì±Î°ùÌïòÏãúÍ≤†ÏäµÎãàÍπå?');
        if (!confirmed) {
            event.preventDefault();
        }
    })
    function validationCheck(){
        const userSession = "<%=session.getAttribute("user") != null ? session.getAttribute("user").toString() : "" %>";
        if (userSession === "") {
            const textarea = document.querySelector("#reviewContents");
            const submitButton = document.querySelector("#rating-form input[type=submit]");

            const confirmed = confirm("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌïú ÏÑúÎπÑÏä§ÏûÖÎãàÎã§. Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌïòÏãúÍ≤†ÏäµÎãàÍπå?");
            if (!confirmed) {
                textarea.blur();
                submitButton.disabled = true;
            }
            else{
                // login.jspÎ°ú Ïù¥Îèô
                window.location.href = "login";
            }
        }
        console.log(userSession);
        console.log(typeof userSession);
    }

    <%--function validationBeforeSubmit(){--%>
    <%--    const userSession = "<%=session.getAttribute("user") != null ? session.getAttribute("user").toString() : "" %>";--%>
    <%--    if (userSession === "") {--%>
    <%--        const textarea = document.getElementById("reviewContents");--%>
    <%--        const confirmed = confirm("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌïú ÏÑúÎπÑÏä§ÏûÖÎãàÎã§. Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌïòÏãúÍ≤†ÏäµÎãàÍπå?");--%>
    <%--        if (!confirmed) {--%>
    <%--            textarea.blur();--%>
    <%--            return false;--%>
    <%--        }--%>
    <%--        else{--%>
    <%--            window.location.href = "login";--%>
    <%--        }--%>
    <%--    }--%>
    <%--    console.log(userSession);--%>
    <%--    console.log(typeof userSession);--%>
    <%--    return true;--%>
    <%--}--%>
</script>
</body>
</html>
